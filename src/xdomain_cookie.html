<!DOCTYPE html>
<HEAD>
	<script>
		window.IframeShim = (function(){

			//orign & namespace data is passed in via urlencoded json object in url hash
			var _hash_data = JSON.parse(decodeURIComponent(window.location.hash.substr(1))),
				_namespace = _hash_data.namespace,
				_origin = _hash_data.origin;

			//basic cookie getter function (returns object of all cookies key/val)
			function _get_local_cookies( cookie_name ){
				var name = cookie_name + "=",
					ca = document.cookie.split(';'),
					cookies = {};
			    for(var i=0; i<ca.length; i++) {
			        var c = ca[i].trim(),
			        	vals = c.split("=");
			        if(!vals[0]) continue;
			        cookies[vals[0]] = decodeURIComponent(vals[1]);
			    }
			    return cookies;
			}

			//basic cookie setter function
			function _set_local_cookie( cookie_name, cookie_value, expires_days ){
				var d = new Date();
			    d.setTime(d.getTime() + (expires_days*1000*60*60*24) );
			    document.cookie = cookie_name + "=" + cookie_value + "; expires="+d.toUTCString();
			}

			//listen for incoming postMessage requests (to write cookie, incoming from local page that loaded iframe)
			window.addEventListener('message', function(event){
				//NOTE - we must filter messages here to verify that it's the specific message/type we are looking for, and not from another window or script
				try{
		        	var data = JSON.parse(event.data);
		        }catch(e){
		        	var data = null;
		        }
		        if(typeof data=='object' &&  'msg_type' in data && data.msg_type=='xdsc_write' && 'namespace' in data && data.namespace === _namespace){
		        	_set_local_cookie( data.cookie_name, data.cookie_val, parseInt(data.expires_days,10) );
		        }
			});

			//initialization - ping parent window w/ cookie payload right away so it an hit callbacks asap
			var msg = {
				cookies: _get_local_cookies(),
				msg_type: 'xdsc_read',
				namespace: _namespace
			};
			//postmessage to parent window w/ data
			window.parent.postMessage(JSON.stringify(msg), _origin);

		})();
	</script>
</HEAD>
</HTML>